<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Pokemon Go Radar REFINED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
    
var map = null;
//var bounds = ((25.040888-0.1, 121.571928-0.1),(25.040888+0.1, 121.571928+0.1));
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}
 
function showPosition(position) {
    console.log('showPosition');
    console.log( position.coords.latitude + '/' + position.coords.longitude);
    if(map!=null) map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
    
}
names = {
1: "妙蛙種子 Bulbasaur",
2: "妙蛙草 Ivysaur",
3: "妙蛙花 Venusaur",
4: "小火龍 Charmander",
5: "火恐龍 Charmeleon",
6: "噴火龍 Charizard",
7: "傑尼龜 Squirtle",
8: "卡咪龜 Wartortle",
9: "水箭龜 Blastoise",
10: "綠毛蟲 Caterpie",
11: "鐵甲蛹 Metapod",
12: "巴大蝴 Butterfree",
13: "獨角蟲 Weedle",
14: "鐵殼蛹 Kakuna",
15: "大針蜂 Beedrill",
16: "波波 Pidgey",
17: "比比鳥 Pidgeotto",
18: "比雕 Pidgeot",
19: "小拉達 Rattata",
20: "拉達 Raticate",
21: "烈雀 Spearow",
22: "大嘴雀 Fearow",
23: "阿柏蛇 Ekans",
24: "阿柏怪 Arbok",
25: "皮卡丘 Pikachu",
26: "雷丘 Raichu",
27: "穿山鼠 Sandshrew",
28: "穿山王 Sandslash",
29: "尼多蘭 Nidoran ♀",
30: "尼多娜 Nidorina",
31: "尼多后 Nidoqueen",
32: "尼多朗 Nidoran ♂",
33: "尼多力諾 Nidorino",
34: "尼多王 Nidoking",
35: "皮皮 Clefairy",
36: "皮可西 Clefable",
37: "六尾 Vulpix",
38: "九尾 Ninetales",
39: "胖丁 Jigglypuff",
40: "胖可丁 Wigglytuff",
41: "超音蝠 Zubat",
42: "大嘴蝠 Golbat",
43: "走路草 Oddish",
44: "臭臭花 Gloom",
45: "霸王花 Vileplume",
46: "派拉斯 Paras",
47: "派拉斯特 Parasect",
48: "毛球 Venonat",
49: "摩魯蛾 Venomoth",
50: "地鼠 Diglett",
51: "三地鼠 Dugtrio",
52: "喵喵 Meowth",
53: "貓老大 Persian",
54: "可達鴨 Psyduck",
55: "哥達鴨 Golduck",
56: "猴怪 Mankey",
57: "火爆猴 Primeape",
58: "卡蒂狗 Growlithe",
59: "風速狗 Arcanine",
60: "蚊香蝌蚪 Poliwag",
61: "蚊香蛙 Poliwhirl",
62: "蚊香泳士 Poliwrath",
63: "凱西 Abra",
64: "勇吉拉 Kadabra",
65: "胡地 Alakazam",
66: "腕力 Machop",
67: "豪力 Machoke",
68: "怪力 Machamp",
69: "喇叭芽 Bellsprout",
70: "口呆花 Weepinbell",
71: "大食花 Victreebel",
72: "瑪瑙水母 Tentacool",
73: "毒刺水母 Tentacruel",
74: "小拳石 Geodude",
75: "隆隆石 Graveler",
76: "隆隆岩 Golem",
77: "小火馬 Ponyta",
78: "烈焰馬 Rapidash",
79: "呆呆獸 Slowpoke",
80: "呆殼獸 Slowbro",
81: "小磁怪 Magnemite",
82: "三合一磁怪 Magneton",
83: "大蔥鴨 Farfetchd",
84: "嘟嘟 Doduo",
85: "嘟嘟利 Dodrio",
86: "小海獅 Seel",
87: "白海獅 Dewgong",
88: "臭泥 Grimer",
89: "臭臭泥 Muk",
90: "大舌貝 Shellder",
91: "鐵甲貝 Cloyster",
92: "鬼斯 Gastly",
93: "鬼斯通 Haunter",
94: "耿鬼 Gengar",
95: "大岩蛇 Onix",
96: "素利普 Drowzee",
97: "素利柏 Hypno",
98: "大鉗蟹 Krabby",
99: "巨鉗蟹 Kingler",
100: "雷電球 Voltorb",
101: "頑皮彈 Electrode",
102: "蛋蛋 Exeggcute",
103: "椰蛋樹 Exeggutor",
104: "卡拉卡拉 Cubone",
105: "嘎拉嘎拉 Marowak",
106: "飛腿郎 Hitmonlee",
107: "快拳郎 Hitmonchan",
108: "大舌頭 Lickitung",
109: "瓦斯彈 Koffing",
110: "雙彈瓦斯 Weezing",
111: "獨角犀牛Rhyhorn",
112: "鐵甲暴龍 Rhydon",
113: "吉利蛋 Chansey",
114: "蔓藤怪 Tangela",
115: "袋龍 Kangaskhan",
116: "墨海馬 Horsea",
117: "海刺龍 Seadra",
118: "角金魚 Goldeen",
119: "金魚王 Seaking",
120: "海星星 Staryu",
121: "?石海星 Starmie",
122: "吸盤魔偶 Mr. Mime",
123: "飛天螳螂 Scyther",
124: "迷唇姐 Jynx",
125: "電擊獸 Electabuzz",
126: "鴨嘴火龍 Magmar",
127: "大甲 Pinsir",
128: "肯泰羅 Tauros",
129: "鯉魚王 Magikarp",
130: "暴鯉龍 Gyarados",
131: "乘龍 Lapras",
132: "百變怪 Ditto",
133: "依布 Eevee",
134: "水精靈 Vaporeon",
135: "雷精靈 Jolteon",
136: "火精靈 Flareon",
137: "三D龍 Porygon",
138: "菊石獸 Omanyte",
139: "多刺菊石獸 Omastar",
140: "化石盔 Kabuto",
141: "鐮刀盔 Kabutops",
142: "化石翼龍 Aerodactyl",
143: "卡比獸 Snorlax",
144: "急凍鳥 Articuno",
145: "閃電鳥 Zapdos",
146: "火焰鳥 Moltres",
147: "迷你龍 Dratini",
148: "哈克龍 Dragonair",
149: "快龍 Dragonite",
150: "超夢 Mewtwo",
151: "夢幻 Mew",
}
// ids=130,143,149
function getQueryVariable(variable) {
    ret = [];
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            items =  decodeURIComponent(pair[1]).split(',');
            for (var j = 0; j < items.length; j++) {
                ret.push(parseInt(items[j]));
            }
            return ret;
        }
    }
    //console.log('Query variable %s not found', variable);
}

var infowindow;
var markerClicked;
function getInfoWindowContent(maker) {
    var d = new Date();
    var n = d.getTime()/1000;
    diff = maker.created+60*15-n;
    title = names[maker.pokemonId] + ' #' + maker.pokemonId + '<br/>time: ' + Math.floor(diff/60) + 'm' + Math.floor(diff%60) + 's' + '<br/>by:' + maker.trainerName + '<br/>up:' + maker. upvotes + ' down:' + maker.downvotes;
    return title;
}
function updateInfoWindow() {
    if(markerClicked!=undefined&&infowindow!=undefined) {
      infowindow.setContent(getInfoWindowContent(markerClicked));
    }
}
function getPokemon(ne,sw) {
  monsters = [3, 5, 6, 9, 15, 22, 24, 26, 28, 31, 34, 36, 38, 40, 42, 45, 51, 52, 53, 56, 57, 59, 62, 64, 65, 66, 67, 68, 71, 73, 74, 75, 78, 80, 81, 82, 83, 86, 87, 88, 89, 91, 92, 93, 94, 95, 96, 97, 100, 101, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 115, 117, 119, 112, 123, 124, 125, 126, 128, 130, 131, 132, 134, 135, 136, 137, 139, 141, , 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154];
   //RADAR
    link = 'http://www.pokeradar.io/api/v1/submissions?deviceId=f4341920706d11e69e747353cbf0865f&minLatitude=' + sw.lat() + '&maxLatitude='+ ne.lat() +'&minLongitude=' +ne.lng() + '&maxLongitude=' +sw.lng() + '&pokemonId=0';
    
    ids = getQueryVariable('ids');
    if(ids==undefined||ids.length==0) ids = monsters;
    //console.log('ids: ' + ids);
    $.get( link, function( data ) {
      $.each(data.data, function( index, obj ) {
        if(obj.userId==13661365 || obj.upvotes>1) {
        if(ids.indexOf(obj.pokemonId) != -1) {
        var icon = {
        url: 'http://df48mbt4ll5mz.cloudfront.net/images/pokemon/'+obj.pokemonId+'.png',
        scaledSize: new google.maps.Size(40, 40), // scaled size
        origin: new google.maps.Point(0,0), // origin
        anchor: new google.maps.Point(0, 0) // anchor
        };

        var marker = new google.maps.Marker({
          position: {lat: obj.latitude, lng: obj.longitude},
          map: map,
          created: obj.created,
          pokemonId: obj.pokemonId,
          trainerName: obj.trainerName,
          upvotes: obj.upvotes,
          downvotes: obj.downvotes,
          icon: icon,
        });
        marker.addListener('click', function() {
          if(infowindow==undefined) infowindow = new google.maps.InfoWindow();
          infowindow.setContent(getInfoWindowContent(this));
          infowindow.open(map, this);
          markerClicked = this;
        });
        }
        }
      });
    });
    /*
  //pkget
  link='https://pkget.com/pkm111.aspx?v1=111&v2=25.032491476997073&v3=121.53444929262105&v4=25.022381163472136&v5=121.51992244859639';
  $.ajax({
  dataType: "json",
  url: link,
  //success: success
  });
  */

}
function initMap() {
  var myLatLng = {lat: 25.040888, lng: 121.571928};

  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 15,
    center: myLatLng
  });

  
  google.maps.event.addListenerOnce(map, 'idle', getLocation);
  
  google.maps.event.addListener(map, 'bounds_changed', function() {
    bounds = map.getBounds(); 
    setTimeout(function() {getPokemon(bounds.getNorthEast(),bounds.getSouthWest());} , 2000)
  });
  setInterval(updateInfoWindow, 1000);
}

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdDb8Mj0WsfyADh8hpeEh_gIkOFhcA2jg&signed_in=true&callback=initMap"></script>
  </body>
</html>